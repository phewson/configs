---
title: "Customer Service Performance Review"
output: html_document
---

![WiFi Spark Logo](logo.jpg)
Report compiled on `r Sys.Date()` for customer id `r c_id`



```{r setup, echo=FALSE, results='hide', include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

```{r header, echo=FALSE, results='hide', include=FALSE, warning=FALSE}
#library(jsonlite)
#library(tibble)
library(tidyr)
library(dplyr)
#library(ggplot2)
#source("~/phewson_configs/sim_and_test/performance_review.R")
```

```{r LoadData, echo=FALSE, results='hide', include=FALSE, warning=FALSE}
#monthly_performance <- fromJSON("~/performance.json", flatten=TRUE)
#monthly_performance <- json_to_df(monthly_performance)
# customers <- unique(monthly_performance$customer_id)
CORPCOLS=c("#2db8c5", "#fdc300", "#2daa56", "#9d9d9c")
customer_data <- monthly_performance  %>% filter(customer_id==c_id)
ddates <- key_dates(customer_data$date)
```


```{r CalculateTotals, echo=FALSE, results='hide', include=FALSE, warning=FALSE}
totals <- customer_data %>%
    filter(date >= ddates$previous_year_starts) %>%
    group_by(variable) %>%
    summarise(value=sum(value)) %>%
    separate(variable, into=c("var", "previous_year"), sep="\\.")
totals$previous_year <- factor(totals$previous_year, levels=c(0, 1), labels=c("Current year", "Previous year"))
```

## Summary of End Users

```{r DevicesSessions1, echo=FALSE, warning=FALSE}
target = c('unique_devices', 'unique_sessions')
labels = c("Devices", "Sessions")
title = "Unique devices and sessions"
subtitle=paste(
    "From ", ddates$this_year_starts, " to ", ddates$this_year_starts, sep="")
df <- customer_data %>% filter(date >= ddates$this_year_starts)
if (length(customer_data$last_year[customer_data$last_year == 0]) >= 3){
perfplot(df, paste(target, ".0", sep=""), labels, title, CORPCOLS[c(3,1)], subtitle, "Unique count", "")
}
```

```{r DevicesSessionsTwo, echo=FALSE, warning=FALSE}
subtitle=paste(
    "Current year ", ddates$this_year_starts, " to ", ddates$this_year_ends,
    "\n", "Previous year ", ddates$previous_year_starts, " to ",
    ddates$previous_year_ends, sep="")
df <- customer_data %>% filter(date >= ddates$previous_year_starts)
if (length(unique(customer_data$last_year)) >= 2){
perfplot(df, adj_target(target), adj_labels(labels), title, CORPCOLS[c(3,1,2,4)], subtitle, "Unique count", "")
}
```

```{r DeviceAnnualTotals, echo=FALSE, warning=FALSE}
if (length(unique(customer_data$last_year)) >= 2){
totplot(totals, target, labels, title, subtitle, "Unique count", "", CORPCOLS[c(3,1)])
}
```

## Summary of data usage


```{r data, echo=FALSE, warning=FALSE}
target = c('corrected_downloaded_gb', 'corrected_uploaded_gb')
labels = c("Downloaded (Gb)", "Uploaded (Gb)")
title = "Data downloaded / uploaded by sessions completed within month"
df <- customer_data %>% filter(date >= ddates$this_year_starts)
subtitle=paste(
    "From ", ddates$this_year_starts, " to ", ddates$this_year_starts, sep="")
if (length(customer_data$last_year[customer_data$last_year == 0]) >= 3){
perfplot(df, paste(target, ".0", sep=""), labels, title, CORPCOLS[c(1:2)], subtitle, "Data (Gb)", " (Gb)")
}
```

```{r data_two, echo=FALSE, warning=FALSE}
subtitle=paste(
    "Current year ", ddates$this_year_starts, " to ", ddates$this_year_ends,
    "\n", "Previous year ", ddates$previous_year_starts, " to ",
    ddates$previous_year_ends, sep="")
df <- customer_data %>% filter(date >= ddates$previous_year_starts)
if (length(unique(customer_data$last_year)) >= 2){
perfplot(df, adj_target(target), adj_labels(labels), title, CORPCOLS[c(3,4,1,2)], subtitle, "Data (Gb)", " (Gb)")
}
```


```{r totals_data, echo=FALSE, warning=FALSE}
if (length(unique(customer_data$last_year)) >= 2){
totplot(totals, target, labels, title, subtitle, "Data (Gb)", " (Gb)", CORPCOLS[c(1,2)])
}
```
